## `build_band_spectr(spec, out_buf)`

Формує “смуговий спектр” — масив рівнів **0..16** по частотних смугах, для подальшої LED-візуалізації на основі енергетичного спектра FFT. Функція працює в **dB-домені**, має **шумовий поріг (gate)**, **AGC-масштабування** і **частотозалежний підсилювач по смугах** (`BAND_GAIN_DB`), який **не впливає на AGC**.

---

### Параметри

- **`spec`**: масив/послідовність чисел (float/int), спектральні значення по бінам FFT.  
  Очікування: `spec[k] >= 0` (енергія/потужність).  
  Використовується функцією `band_dbfs(spec, i, j)` для підрахунку рівня смуги в dBFS.

- **`out_buf`**: змінюваний буфер (наприклад, `bytearray`, `array('B')`, list int), довжина **`NUM_BAND`**.  
  На виході `out_buf[i]` містить рівень смуги `i` у діапазоні **0..16**.

---

### Залежні константи / глобальні параметри

- **`IND_BANDS`**: послідовність ширин смуг у бінах FFT; сума ширин задає охоплення спектра.  
- **`NUM_BAND`**: кількість смуг (має відповідати `len(IND_BANDS)`).
- **`NOISE_THRESHOLD[i]`**: зсув (в dB) для кожної смуги, що реалізує шумовий поріг / компенсацію.
- **`BAND_GAIN_DB[i]`**: підсилення/ослаблення (в dB) для кожної смуги (еквалайзер).  
  **Важливо:** `BAND_GAIN_DB` застосовується **після** розрахунку AGC і **не впливає** на `_scale_db`.
- **`HEADROOM_DB`**: запас по піку (в dB) для AGC.
- **`SCALE_DECAY_DB`**: швидкість “спаду” масштабу `_scale_db` (в dB на кадр).
- **`SCALE_MIN_DB`**: нижня межа `_scale_db` (в dB), щоб уникати надмірного підсилення тиші.
- **`GAMMA`**: параметр нелінійності мапінгу (гамма-корекція), `y = x**GAMMA`.
- **`_scale_db`** (global): поточний AGC-масштаб у dB.
- **`_tmp_adj`** (global): тимчасовий масив (довжина `NUM_BAND`) для збереження `adj` по смугах.

---

### Вихідні значення

- Для кожної смуги `i` записується `out_buf[i]`:
  - `0` — смуга нижче порогу (після gate).
  - `1..16` — рівень смуги після нормалізації, гамма-корекції і квантування.

---

### Алгоритм (покроково)

#### 1) Оцінка рівня кожної смуги в dB + шумовий поріг (gate)

Для кожної смуги `i` береться діапазон бінів `[ind, ind + w)`:

1. Обчислюється рівень смуги в dB:
   - `db = band_dbfs(spec, ind, ind + w)`
2. Застосовується поріг/зсув:
   - `adj = db + NOISE_THRESHOLD[i]`
3. Застосовується gate:
   - `adj = max(0, adj)`
4. `adj` зберігається у `_tmp_adj[i]`.
5. Паралельно формується `peak_adj = max(peak_adj, adj)`.

> На цьому етапі **`BAND_GAIN_DB` не застосовується**.

---

#### 2) AGC-масштабування (без урахування `BAND_GAIN_DB`)

AGC використовує лише `peak_adj` з попереднього кроку:

- `target = peak_adj + HEADROOM_DB`

Оновлення `_scale_db`:

- якщо `target > _scale_db`: `_scale_db = target` (швидка “атака” вгору)
- інакше `_scale_db -= SCALE_DECAY_DB` (повільний “спад” вниз), але не нижче `target`
- `_scale_db` також обмежується знизу `SCALE_MIN_DB`

Дільник для нормалізації:

- `denom = max(_scale_db, 1e-6)`

---

#### 3) Частотозалежний gain (EQ) + нормалізація + мапінг у 0..16

Для кожної смуги:

1. Береться `adj = _tmp_adj[i]`. Якщо `adj <= 0`, то `out_buf[i] = 0`.

2. Підсилення/ослаблення для кожної смуги (у dB):
   
   - `adj_eff = max(0, adj + BAND_GAIN_DB[i])`

3. Нормалізація відносно AGC:
   
   - `x = clamp(adj_eff / denom, 0..1)`

4. Гамма-корекція:
   
   - `y = x ** GAMMA`
     При цьому:
     - `GAMMA < 1` піднімає низ (тихі смуги стають помітніші).
     - `GAMMA = 1` лінійно.
     - `GAMMA > 1` пригнічує низ.

5. Квантування у рівень:
   
   - `lvl = 1 + int(y * 15.0 + 0.5)`  → `1..16`
   - обмеження: `lvl = min(lvl, 16)`

6. Запис у вихід:
   
   - `out_buf[i] = lvl`

---

### Властивості та примітки

- **`BAND_GAIN_DB` не впливає на AGC**: `_scale_db` і `denom` визначаються тільки з “сирих” `adj` (після noise gate).
  - Наслідок: підсилені смуги можуть частіше досягати `16` (обмеження по максимуму), але загальна динаміка AGC не змінюється.
- `len(BAND_GAIN_DB)` має дорівнювати `NUM_BAND`.
- `len(NOISE_THRESHOLD)` має дорівнювати `NUM_BAND`.
- `spec` містить “потужність” (а не амплітуди), відповідно `band_dbfs()` узгоджена з цією інтерпретацією.

---

## Параметри та їхній вплив

### `IND_BANDS` (16 значень)

**Впливає на** частотну роздільність:

- більше бінів у смузі → більш гладка індикація, менше “смикання”
- менше бінів → вища роздільність, але більше шуму/варіацій

---

### `NOISE_THRESHOLD[i]` (16 значень)

Порог для кожної смуги (у dBFS, через знак):

- `noise_dbfs[i] = -NOISE_THRESHOLD[i]`

**Більше `NOISE_THRESHOLD` → нижчий поріг (більш чутливо).**  
Напр.: 90 → поріг -90 dBFS (дуже чутливо), 50 → поріг -50 dBFS (менш чутливо).

---

### `HEADROOM_DB`

Запас над піком для масштабу.

- **Збільшити** → верхні рівні досягаються рідше, менше “залипання” на 16, стабільніше.
- **Зменшити** → 16 досягається частіше (агресивніша шкала).

---

### `SCALE_DECAY_DB`

Швидкість зменшення `_scale_db` при затиханні (release).

- **Більше** → швидше “відпускає” масштаб, індикатор швидше оживає після гучного піку, але більше “пампінгу”.
- **Менше** → плавніше, стабільніше, але після піку може бути короткий період “приглушення”.

---

### `SCALE_MIN_DB`

Нижня межа масштабу `_scale_db`.

- **Більше** → менш чутливо (потрібно більше dB над порогом для видимого рівня).
- **Менше** → більш чутливо (ризик підняти шум, якщо `NOISE_THRESHOLD` слабкий).

---

### `GAMMA`

Нелінійна компресія (візуальна “крива”):

- `GAMMA = 0.5..0.8` — піднімає тихі смуги (часто корисно для музики).
- `GAMMA ≈ 1.0` — лінійно.
- `GAMMA > 1.0` — робить індикатор більш “контрастним” (тихе майже зникає).

---

## Практичний порядок підлаштування

1) **`NOISE_THRESHOLD[]`**: при тиші більшість смуг мають бути 0 (або дуже рідкі 1).  
2) **`HEADROOM_DB`**: визначає, як часто індикатор торкається 16.  
3) **`SCALE_DECAY_DB`**: прибирає/додає “пампінг” при зміні гучності.  
4) **`GAMMA`**: підлаштовує вигляд низу (тихих смуг) без зміни порогів.
5) **`BAND_GAIN_DB`**: при необхідності, підняти / опустити деякі смуги.
   Приклад:
   Підняти верхні 4 смуги (в dB):

```python
BAND_GAIN_DB = (
    0, 0, 0, 0,
    0, 0, 0, 0,
    0, 0, 0, 0,
    3, 6, 9, 12
)

---
```
